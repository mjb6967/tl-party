<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TL DPS Party</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
        }
        
        .card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            color: #22d3ee;
            margin-bottom: 8px;
            font-size: 1.75rem;
        }
        
        .subtitle {
            text-align: center;
            color: #64748b;
            margin-bottom: 24px;
            font-size: 0.9rem;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: 1px solid #334155;
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.5);
            color: #e2e8f0;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            width: 100%;
        }
        
        .btn:hover {
            background: rgba(30, 41, 59, 0.8);
            border-color: #22d3ee;
        }
        
        .btn-discord {
            background: #5865F2;
            border-color: #5865F2;
        }
        
        .btn-discord:hover {
            background: #4752c4;
            border-color: #4752c4;
        }
        
        .btn-primary {
            background: #22d3ee;
            border-color: #22d3ee;
            color: #0f172a;
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background: #06b6d4;
        }
        
        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .btn-success {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #22c55e;
        }
        
        .btn-success:hover {
            background: rgba(34, 197, 94, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-row {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        .btn-row .btn {
            flex: 1;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #334155;
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #334155;
        }
        
        .user-name {
            flex: 1;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .logout-btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            width: auto;
        }
        
        .section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 12px;
        }
        
        .party-code {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .party-code .code {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Consolas', monospace;
            color: #22d3ee;
            letter-spacing: 0.2em;
        }
        
        .party-code .label {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 4px;
        }
        
        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .input-group input {
            flex: 1;
            padding: 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 1rem;
            text-transform: uppercase;
            text-align: center;
            letter-spacing: 0.1em;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #22d3ee;
        }
        
        .input-group .btn {
            width: auto;
            padding: 12px 20px;
        }
        
        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #64748b;
            font-size: 0.8rem;
        }
        
        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #334155;
        }
        
        .divider span {
            padding: 0 12px;
        }
        
        .members-list {
            margin: 16px 0;
        }
        
        .member {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            margin-bottom: 6px;
        }
        
        .member-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #334155;
        }
        
        .member-name {
            flex: 1;
            font-weight: 500;
        }
        
        .member-status {
            display: flex;
            gap: 6px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #64748b;
        }
        
        .status-dot.online {
            background: #22c55e;
            box-shadow: 0 0 6px rgba(34, 197, 94, 0.5);
        }
        
        .leader-badge {
            font-size: 0.7rem;
            background: #fbbf24;
            color: #0f172a;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .encounter-controls {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .encounter-controls .btn {
            flex: 1;
            padding: 16px;
            font-size: 1.1rem;
        }
        
        .encounter-status {
            text-align: center;
            padding: 12px;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid #fbbf24;
            border-radius: 8px;
            color: #fbbf24;
            margin-bottom: 16px;
        }
        
        .encounter-status.active {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .target-group {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #334155;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        
        .target-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid #334155;
        }
        
        .target-name {
            font-weight: 600;
            color: #e2e8f0;
            font-size: 1rem;
        }
        
        .target-damage {
            color: #22d3ee;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .results-table th {
            text-align: left;
            padding: 10px 16px;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #64748b;
            border-bottom: 1px solid #334155;
        }
        
        .results-table th:last-child,
        .results-table td:last-child {
            text-align: right;
        }
        
        .results-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(51, 65, 85, 0.3);
        }
        
        .results-table tr:last-child td {
            border-bottom: none;
        }
        
        .results-table .rank {
            font-weight: 700;
            width: 40px;
        }
        
        .results-table .rank-1 { color: #fbbf24; }
        .results-table .rank-2 { color: #94a3b8; }
        .results-table .rank-3 { color: #cd7f32; }
        .results-table .rank-other { color: #64748b; }
        
        .results-table .damage {
            font-weight: 600;
            color: #22d3ee;
            font-variant-numeric: tabular-nums;
        }
        
        .results-table .dps {
            color: #a78bfa;
            font-variant-numeric: tabular-nums;
        }
        
        .results-table .percent {
            color: #64748b;
            font-size: 0.85rem;
        }
        
        .results-total {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-top: 12px;
            font-weight: 600;
        }
        
        .results-total .label {
            color: #94a3b8;
        }
        
        .results-total .value {
            color: #22d3ee;
        }
        
        .no-results {
            text-align: center;
            color: #64748b;
            padding: 24px;
        }
        
        .agent-token {
            margin-top: 16px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .agent-token .label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 6px;
        }
        
        .agent-token .token {
            font-family: 'Consolas', monospace;
            font-size: 0.8rem;
            color: #94a3b8;
            word-break: break-all;
            user-select: all;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login View -->
        <div id="loginView" class="card">
            <h1>TL DPS Party</h1>
            <p class="subtitle">Party damage meter for Throne and Liberty</p>
            <a href="/auth/login" class="btn btn-discord">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                </svg>
                Login with Discord
            </a>
        </div>
        
        <!-- Logged In - No Party -->
        <div id="lobbyView" class="card hidden">
            <div class="user-info">
                <img id="userAvatar" class="user-avatar" src="" alt="">
                <span id="userName" class="user-name">Username</span>
                <button class="btn logout-btn" onclick="logout()">Logout</button>
            </div>
            
            <div class="section-title">Create a Party</div>
            <button class="btn btn-primary" onclick="createParty()">Create New Party</button>
            
            <div class="divider"><span>or</span></div>
            
            <div class="section-title">Join a Party</div>
            <div class="input-group">
                <input type="text" id="joinCode" placeholder="CODE" maxlength="4">
                <button class="btn" onclick="joinParty()">Join</button>
            </div>
            
            <div class="agent-token">
                <div class="label">Agent Token (paste into your local app)</div>
                <div class="token" id="agentToken">-</div>
            </div>
        </div>
        
        <!-- In Party View -->
        <div id="partyView" class="card hidden">
            <div class="user-info">
                <img id="partyUserAvatar" class="user-avatar" src="" alt="">
                <span id="partyUserName" class="user-name">Username</span>
                <button class="btn logout-btn btn-danger" onclick="leaveParty()">Leave Party</button>
            </div>
            
            <div class="party-code">
                <div class="code" id="partyCode">XXXX</div>
                <div class="label">Party Code - Share with your group</div>
            </div>
            
            <div id="encounterStatus" class="encounter-status hidden">
                Encounter in progress...
            </div>
            
            <div class="section-title">Members (<span id="memberCount">0</span>)</div>
            <div class="members-list" id="membersList"></div>
            
            <div id="leaderControls" class="encounter-controls hidden">
                <button class="btn btn-success" id="startBtn" onclick="startEncounter()">Start Encounter</button>
                <button class="btn btn-danger" id="endBtn" onclick="endEncounter()" disabled>End Encounter</button>
            </div>
            
            <div id="resultsSection" class="hidden">
                <div class="section-title" style="margin-top: 20px;">Encounter Results</div>
                <div id="groupedResults">
                    <!-- Grouped results will be rendered here -->
                </div>
            </div>
            
            <div id="noResults" class="no-results">
                No encounter results yet. Leader can start an encounter above.
            </div>
        </div>
    </div>
    
    <script>
        // State
        let token = null;
        let user = null;
        let party = null;
        let ws = null;
        
        // Utils
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }
        
        function getAvatarUrl(userId, avatarHash) {
            if (!avatarHash) return 'https://cdn.discordapp.com/embed/avatars/0.png';
            return `https://cdn.discordapp.com/avatars/${userId}/${avatarHash}.png`;
        }
        
        // API calls
        async function api(endpoint, options = {}) {
            const url = endpoint + (endpoint.includes('?') ? '&' : '?') + `token=${token}`;
            const response = await fetch(url, {
                ...options,
                headers: { 'Content-Type': 'application/json', ...options.headers },
            });
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.detail || 'Request failed');
            }
            return response.json();
        }
        
        // Views
        function showView(viewId) {
            document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }
        
        function updateUserInfo() {
            const avatar = getAvatarUrl(user.id, user.avatar);
            document.getElementById('userAvatar').src = avatar;
            document.getElementById('userName').textContent = user.username;
            document.getElementById('partyUserAvatar').src = avatar;
            document.getElementById('partyUserName').textContent = user.username;
            document.getElementById('agentToken').textContent = user.agent_token;
        }
        
        function updatePartyView() {
            document.getElementById('partyCode').textContent = party.code;
            document.getElementById('memberCount').textContent = party.members.length;
            
            // Members list
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = party.members.map(m => `
                <div class="member">
                    <img class="member-avatar" src="${getAvatarUrl(m.user_id, m.avatar)}">
                    <span class="member-name">${m.username}</span>
                    ${m.user_id === party.leader_id ? '<span class="leader-badge">LEADER</span>' : ''}
                    <div class="member-status">
                        <span class="status-dot ${m.connected ? 'online' : ''}" title="Web"></span>
                        <span class="status-dot ${m.agent_connected ? 'online' : ''}" title="Agent"></span>
                    </div>
                </div>
            `).join('');
            
            // Leader controls
            const isLeader = party.leader_id === user.id;
            document.getElementById('leaderControls').classList.toggle('hidden', !isLeader);
            
            // Encounter status
            const statusEl = document.getElementById('encounterStatus');
            const startBtn = document.getElementById('startBtn');
            const endBtn = document.getElementById('endBtn');
            
            if (party.encounter_active) {
                statusEl.classList.remove('hidden');
                statusEl.classList.add('active');
                statusEl.textContent = 'Encounter in progress...';
                startBtn.disabled = true;
                endBtn.disabled = false;
            } else {
                statusEl.classList.add('hidden');
                statusEl.classList.remove('active');
                startBtn.disabled = false;
                endBtn.disabled = true;
            }
            
            // Results
            updateGroupedResults(party.grouped_results);
        }
        
        function updateGroupedResults(groupedResults) {
            const hasResults = groupedResults && groupedResults.length > 0;
            document.getElementById('resultsSection').classList.toggle('hidden', !hasResults);
            document.getElementById('noResults').classList.toggle('hidden', hasResults);
            
            if (!hasResults) return;
            
            const container = document.getElementById('groupedResults');
            
            container.innerHTML = groupedResults.map(group => `
                <div class="target-group">
                    <div class="target-header">
                        <span class="target-name">‚öîÔ∏è ${group.target}</span>
                        <span class="target-damage">${formatNumber(group.total_damage)} total</span>
                    </div>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Player</th>
                                <th>Damage</th>
                                <th>%</th>
                                <th>DPS</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${group.results.map(r => `
                                <tr>
                                    <td class="rank rank-${r.rank <= 3 ? r.rank : 'other'}">${getRankMedal(r.rank)}</td>
                                    <td>${r.username}</td>
                                    <td class="damage">${formatNumber(r.total_damage)}</td>
                                    <td class="percent">${r.percent}%</td>
                                    <td class="dps">${formatNumber(Math.round(r.dps))}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `).join('');
        }
        
        function getRankMedal(rank) {
            if (rank === 1) return 'ü•á';
            if (rank === 2) return 'ü•à';
            if (rank === 3) return 'ü•â';
            return '#' + rank;
        }
        
        // WebSocket
        function connectWS() {
            if (ws) ws.close();
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws?token=${token}&source=web`);
            
            ws.onopen = () => console.log('WebSocket connected');
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                setTimeout(connectWS, 3000);
            };
            ws.onerror = (e) => console.error('WebSocket error:', e);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWSMessage(data);
            };
        }
        
        function handleWSMessage(data) {
            console.log('WS:', data);
            
            switch (data.type) {
                case 'member_joined':
                case 'member_left':
                case 'member_status':
                case 'leader_changed':
                    // Refresh party data
                    loadParty();
                    break;
                    
                case 'encounter_start':
                    party.encounter_active = true;
                    party.results = [];
                    party.grouped_results = [];
                    updatePartyView();
                    break;
                    
                case 'encounter_end':
                    party.encounter_active = false;
                    updatePartyView();
                    break;
                    
                case 'results_update':
                    party.encounter_target = data.target;
                    party.results = data.results;
                    party.grouped_results = data.grouped_results;
                    updateGroupedResults(data.grouped_results);
                    break;
            }
        }
        
        // Actions
        async function createParty() {
            try {
                const result = await api('/party/create', { method: 'POST' });
                // Update user object with new party info
                user.party = { code: result.code };
                await loadParty();
                showView('partyView');
            } catch (e) {
                alert('Failed to create party: ' + e.message);
            }
        }
        
        async function joinParty() {
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            if (!code || code.length !== 4) {
                alert('Please enter a 4-character party code');
                return;
            }
            
            try {
                const result = await api(`/party/join/${code}`, { method: 'POST' });
                // Update user object with party info
                user.party = { code: result.code || code };
                await loadParty();
                showView('partyView');
            } catch (e) {
                alert('Failed to join party: ' + e.message);
            }
        }
        
        async function leaveParty() {
            try {
                await api('/party/leave', { method: 'POST' });
                party = null;
                showView('lobbyView');
            } catch (e) {
                alert('Failed to leave party: ' + e.message);
            }
        }
        
        async function startEncounter() {
            try {
                await api(`/party/${party.code}/start`, { method: 'POST' });
            } catch (e) {
                alert('Failed to start encounter: ' + e.message);
            }
        }
        
        async function endEncounter() {
            try {
                await api(`/party/${party.code}/end`, { method: 'POST' });
            } catch (e) {
                alert('Failed to end encounter: ' + e.message);
            }
        }
        
        async function loadParty() {
            const code = user.party?.code;
            if (!code) return;
            
            try {
                party = await api(`/party/${code}`);
                updatePartyView();
            } catch (e) {
                console.error('Failed to load party:', e);
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            token = null;
            user = null;
            party = null;
            if (ws) ws.close();
            showView('loginView');
        }
        
        // Init
        async function init() {
            // Check for token in URL (from OAuth callback)
            const params = new URLSearchParams(window.location.search);
            const urlToken = params.get('token');
            if (urlToken) {
                localStorage.setItem('token', urlToken);
                window.history.replaceState({}, '', '/');
            }
            
            // Load token from storage
            token = localStorage.getItem('token');
            if (!token) {
                showView('loginView');
                return;
            }
            
            // Verify token and get user info
            try {
                user = await api('/auth/me');
                updateUserInfo();
                
                if (user.party) {
                    party = { code: user.party.code };
                    await loadParty();
                    showView('partyView');
                } else {
                    showView('lobbyView');
                }
                
                connectWS();
            } catch (e) {
                console.error('Auth failed:', e);
                logout();
            }
        }
        
        init();
    </script>
</body>
</html>
